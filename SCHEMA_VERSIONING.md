# PhoenixKit Schema Versioning & Migration Guide

PhoenixKit –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ö–∞–∂–¥–∞—è –≤–µ—Ä—Å–∏—è PhoenixKit –∏–º–µ–µ—Ç –≤–µ—Ä—Å–∏—é —Å—Ö–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `1.0.0`)
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω—É–∂–Ω–∞—è —Å—Ö–µ–º–∞
- –í–µ—Ä—Å–∏—è —Å—Ö–µ–º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `phoenix_kit_schema_versions`
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### –¢–∞–±–ª–∏—Ü–∞ –≤–µ—Ä—Å–∏–π
```sql
CREATE TABLE phoenix_kit_schema_versions (
  id bigserial PRIMARY KEY,
  version varchar(50) NOT NULL,
  applied_at timestamp NOT NULL DEFAULT NOW(),
  inserted_at timestamp NOT NULL DEFAULT NOW()
);
```

## üì¶ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```elixir
# 1. –û–±–Ω–æ–≤–∏—Ç–µ –≤–µ—Ä—Å–∏—é –≤ mix.exs
{:phoenix_kit, "~> 2.0"}

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
mix deps.get

# 3. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ /phoenix_kit/register –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è!
```

### –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º (–¥–ª—è production)
```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å—Ö–µ–º—ã
mix phoenix_kit.migrate --status

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é
mix phoenix_kit.migrate

# 3. –ò–ª–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
mix phoenix_kit.migrate --repo MyApp.Repo
```

## üîç –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
$ mix phoenix_kit.migrate --status

PhoenixKit Schema Status
=======================

Repository: MyApp.Repo
Installed Version: 1.0.0
Target Version: 2.0.0
Migration Required: YES

üìã Action Required: Schema upgrade
   Upgrade from 1.0.0 to 2.0.0
   This is a safe operation that preserves existing data

To apply migration: mix phoenix_kit.migrate
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
$ mix phoenix_kit.migrate

Starting PhoenixKit schema migration...
From: 1.0.0
To: 2.0.0

‚ö†Ô∏è  This will upgrade your PhoenixKit schema
   From version: 1.0.0
   To version: 2.0.0
   This operation preserves existing data

Proceed with schema upgrade? [Yn] y

Applying migration...
[info] [PhoenixKit] Schema migration from 1.0.0 to 2.0.0
[info] [PhoenixKit] Applying migration to schema version 2.0.0
[info] [PhoenixKit] Schema migration completed successfully

‚úÖ Migration completed successfully!

PhoenixKit schema is now at version 2.0.0
Authentication tables are ready for use.
```

## üõ°Ô∏è –ü—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –î–æ–±–∞–≤–ª—è—é—Ç –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –∫–∞–∫ nullable
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç `ALTER TABLE` –≤–º–µ—Å—Ç–æ `DROP/CREATE`

### 2. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `IF NOT EXISTS` –∏ `IF EXISTS`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

### 3. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –°—Ç–∞—Ä—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –≤ minor –≤–µ—Ä—Å–∏—è—Ö
- ‚úÖ API –æ—Å—Ç–∞–µ—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º –º–µ–∂–¥—É minor –≤–µ—Ä—Å–∏—è–º–∏
- ‚úÖ Breaking changes —Ç–æ–ª—å–∫–æ –≤ major –≤–µ—Ä—Å–∏—è—Ö

## üìã –ü—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π

### –í–µ—Ä—Å–∏—è 1.0.0 ‚Üí 1.1.0 (Minor Update)
```sql
-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É
ALTER TABLE phoenix_kit ADD COLUMN phone varchar(20);

-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
CREATE INDEX CONCURRENTLY phoenix_kit_phone_index ON phoenix_kit (phone);
```

### –í–µ—Ä—Å–∏—è 1.x.x ‚Üí 2.0.0 (Major Update) 
```sql
-- –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å breaking changes
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –∑–∞—Ä–∞–Ω–µ–µ
-- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### "Migration failed: permission denied"
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ CREATE TABLE
GRANT CREATE ON SCHEMA public TO myuser;
GRANT USAGE ON SCHEMA public TO myuser;
```

### "Extension citext does not exist"
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–∞–∫ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å PostgreSQL
CREATE EXTENSION IF NOT EXISTS citext;
```

### "Could not detect repository"
```bash
# –£–∫–∞–∂–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —è–≤–Ω–æ
mix phoenix_kit.migrate --repo MyApp.Repo
```

### –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
```bash
# –í –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –±—É–¥–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è
mix phoenix_kit.migrate --rollback 1.0.0
```

## üîÆ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

### v1.1 (–±–ª–∏–∂–∞–π—à–∞—è –≤–µ—Ä—Å–∏—è)
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ rollback –º–∏–≥—Ä–∞—Ü–∏–π
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö  
- [ ] –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç —Å—Ö–µ–º—ã

### v2.0 (–±—É–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è)
- [ ] –ú–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å (—Ä–∞–∑–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã —Ç–∞–±–ª–∏—Ü)
- [ ] –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ users —Ç–∞–±–ª–∏—Ü–∞–º–∏

## üìö API Reference

### PhoenixKit.SchemaMigrations

```elixir
# –ü–æ–ª—É—á–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Å—Ö–µ–º—ã
PhoenixKit.SchemaMigrations.get_installed_version(repo)
#=> "1.0.0" | nil

# –ü–æ–ª—É—á–∏—Ç—å —Ü–µ–ª–µ–≤—É—é –≤–µ—Ä—Å–∏—é (–∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏)
PhoenixKit.SchemaMigrations.get_target_version()
#=> "1.0.0"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è
PhoenixKit.SchemaMigrations.migration_required?(repo)
#=> true | false

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
PhoenixKit.SchemaMigrations.migrate_to_current(repo)
#=> :ok | {:error, reason}
```

## üí° Best Practices

### Production Deployment
1. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ staging** - –≤—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ staging
2. **–î–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø—ã** - —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏  
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏
4. **Maintenance window** - –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –≤ –æ–∫–Ω–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

### Development Workflow
1. **–û–±–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** - `mix deps.get`
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å** - `mix phoenix_kit.migrate --status`
3. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ** - —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

---

**–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ PhoenixKit –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π! üöÄ**